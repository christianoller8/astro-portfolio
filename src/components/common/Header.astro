---
import ThemeToggle from './ThemeToggle.astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const navItems = [
  { key: 'nav.home', path: '/' },
  { key: 'nav.projects', path: '/projects' },
  { key: 'nav.about', path: '/about' },
  { key: 'nav.contact', path: '/contact' },
] as const;

const isActive = (path: string) => {
  const targetPath = translatePath(path);
  const currentPath = Astro.url.pathname.replace(/\/$/, '');
  const targetNormalized = targetPath.replace(/\/$/, '');
  
  if (path === '/') return currentPath === targetNormalized;
  return currentPath.startsWith(targetNormalized);
};

const getLinkClass = (path: string) => {
  const base = "text-sm font-medium transition-colors hover:text-primary";
  const active = "text-primary font-bold";
  const inactive = "text-muted-foreground";
  return `${base} ${isActive(path) ? active : inactive}`;
};
---

<header class="sticky top-0 z-50 w-full border-b border-border/40 bg-background/80 backdrop-blur-md transition-colors duration-300">
  <div class="mx-auto flex h-16 w-full max-w-[1400px] items-center justify-end px-6 md:px-12 lg:px-20">
    
    <nav class="hidden md:block">
      <ul class="flex items-center gap-2">
        {navItems.map((item, index) => (
          <li class="flex items-center gap-2">
            <a href={translatePath(item.path)} class={getLinkClass(item.path)}>
              {t(item.key)}
            </a>
            {index < navItems.length - 1 && (
              <span class="text-accent select-none text-muted-foreground/40" aria-hidden="true">/</span>
            )}
          </li>
        ))}
      </ul>
    </nav>

    <div class="hidden md:flex items-center gap-2 ml-6 mr-2 text-xs font-medium border-l border-border/40 pl-6">
      <a href="/" class={`transition-colors hover:text-primary ${lang === 'es' ? 'text-primary font-bold' : 'text-muted-foreground'}`}>ES</a>
      <span class="text-muted-foreground/40">/</span>
      <a href="/en/" class={`transition-colors hover:text-primary ${lang === 'en' ? 'text-primary font-bold' : 'text-muted-foreground'}`}>EN</a>
    </div>

    <div class="ml-2 hidden md:block">
      <ThemeToggle />
    </div>

    <div class="flex items-center gap-4 md:hidden">
        <div class="flex items-center gap-1 text-xs font-bold">
            <a href="/" class={lang === 'es' ? 'text-primary' : 'text-muted-foreground'}>ES</a>
            <span class="text-muted-foreground/30">/</span>
            <a href="/en/" class={lang === 'en' ? 'text-primary' : 'text-muted-foreground'}>EN</a>
        </div>
      <ThemeToggle />
      <button id="mobile-menu-btn" class="text-secondary hover:text-primary p-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
      </button>
    </div>
  </div>

  <div id="mobile-menu" class="bg-background hidden border-t border-border/40 md:hidden dark:bg-neutral-950">
    <nav class="container flex flex-col gap-4 p-6 text-sm font-medium">
      {navItems.map((item) => (
        <a href={translatePath(item.path)} class={getLinkClass(item.path)}>
          {t(item.key)}
        </a>
      ))}
    </nav>
  </div>
</header>

<script>
  const btn = document.getElementById('mobile-menu-btn');
  const menu = document.getElementById('mobile-menu');
  if (btn && menu) btn.addEventListener('click', () => menu.classList.toggle('hidden'));
</script>
